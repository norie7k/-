# 预计算方案 - 逻辑与流程说明

## 📋 方案概述

**核心问题**：Streamlit Cloud 免费版有 10 分钟超时限制，无法在云端完成完整的数据分析（需要 5 小时+）

**解决方案**：本地预计算 → 保存结果 → 推送到 GitHub → 网页查看历史结果

---

## 🔄 完整流程（3 个阶段）

```
┌─────────────────────────────────────────────────────────────┐
│  阶段 1: 数据准备                                            │
│  ─────────────────────────────────────────────────────────  │
│  1. 下载 QQ 群聊天记录 (download_chat.py)                   │
│     ↓                                                        │
│  2. 保存为 txt 文件到 SOURCE_DIR                            │
│     - 《欢迎来到地球》测试1群.txt                            │
│     - 《欢迎来到地球》测试2群.txt                            │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│  阶段 2: 数据分析（本地执行，耗时 5 小时+）                  │
│  ─────────────────────────────────────────────────────────  │
│  1. 自动注入日期和文件配置到 Notebook                       │
│     - start_time, end_time                                 │
│     - pathtxt (txt 文件名)                                  │
│     - MAPPING_FILE (映射文件)                               │
│     ↓                                                        │
│  2. 并行执行两个 Notebook                                    │
│     - top5_Q2_group1.ipynb (地球群1)                       │
│     - top5_Q2_group2.ipynb (地球群2)                       │
│     ↓                                                        │
│  3. Notebook 内部流程：                                      │
│     a) 读取 txt 文件，转换为 JSONL 格式                     │
│     b) 按批次调用 API（模型#1: 筛选）                       │
│     c) 按批次调用 API（模型#2: 聚类）                       │
│     d) 调用 API（模型#3: 聚合）                             │
│     e) 调用 API（模型#4: 观点分析）                         │
│     f) 输出 Top 5 热门话题簇                                │
│     ↓                                                        │
│  4. Notebook 输出 JSON 格式的分析结果                       │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│  阶段 3: 结果保存与展示                                      │
│  ─────────────────────────────────────────────────────────  │
│  1. 保存结果 (save_results.py)                              │
│     - 解析 Notebook 输出的 JSON                             │
│     - 按日期和群分组保存到 results/                         │
│     - 更新索引文件 (index.json)                             │
│     ↓                                                        │
│  2. 推送到 GitHub                                            │
│     - git add results/                                      │
│     - git commit                                            │
│     - git push                                              │
│     ↓                                                        │
│  3. 网页展示 (app.py - Streamlit)                           │
│     - 从 GitHub 读取 JSON 结果                             │
│     - 提供日期和群选择                                      │
│     - 展示分析报告（与 H5 包装格式一致）                    │
└─────────────────────────────────────────────────────────────┘
```

---

## 📁 目录结构

```
预计算方案/
├── app.py                          # Streamlit 网页（查看历史结果）
├── auto_download/                  # 自动化脚本目录
│   ├── config.py                   # 配置文件（路径、群配置、Notebook 配置）
│   ├── download_chat.py            # 自动下载 QQ 聊天记录（点击脚本）
│   ├── run_notebook.py             # 执行 Notebook（注入配置 + 并行运行）
│   ├── run_yesterday.py            # 运行昨天的分析（快捷脚本）
│   ├── save_results.py              # 保存结果到 results/ 并推送到 GitHub
│   ├── full_pipeline.py            # 完整流程（下载 + 分析 + 保存 + 推送）
│   └── calibrate.py                # 校准点击坐标（用于 download_chat.py）
├── results/                        # 分析结果目录
│   ├── group1/                     # 地球群1 的结果
│   │   ├── index.json              # 群1 的索引（可用日期列表）
│   │   ├── 2025-12-17.json         # 2025-12-17 的分析结果
│   │   └── 2025-12-18.json         # 2025-12-18 的分析结果
│   ├── group2/                     # 地球群2 的结果
│   │   ├── index.json
│   │   └── ...
│   └── index.json                   # 总索引（所有群和日期）
└── notebook_helper.py               # Notebook 辅助函数（可选，用于在 Notebook 内直接保存）
```

---

## 🔧 核心组件说明

### 1. config.py - 配置中心

**作用**：统一管理路径、群配置、Notebook 配置

**关键配置**：
- `PROJECT_ROOT`: 项目根目录
- `SOURCE_DIR`: Notebook 和 txt 文件所在目录
- `RESULTS_DIR`: 结果保存目录
- `NOTEBOOKS`: Notebook 配置列表（每个群一个）
  ```python
  NOTEBOOKS = [
      {
          "name": "地球群1",
          "notebook": SOURCE_DIR / "top5_Q2_group1.ipynb",
          "mapping_file": "mapping地球1.xlsx",
          "txt_pattern": "《欢迎来到地球》测试1群.txt",
      },
      {
          "name": "地球群2",
          "notebook": SOURCE_DIR / "top5_Q2_group2.ipynb",
          "mapping_file": "mapping地球2.xlsx",
          "txt_pattern": "《欢迎来到地球》测试2群.txt",
      },
  ]
  ```

---

### 2. run_notebook.py - Notebook 执行引擎

**核心功能**：

#### a) `inject_date_into_notebook()` - 配置注入
- 读取原始 Notebook
- 在开头插入配置 cell，设置：
  - `start_time = "2025-12-24 00:00:00"`
  - `end_time = "2025-12-25 00:00:00"`
  - `pathtxt = "《欢迎来到地球》测试1群.txt"`（支持日期前缀匹配）
  - `MAPPING_FILE = "mapping地球1.xlsx"`
- 注释掉 Notebook 中已有的同名变量赋值
- 保存为临时 Notebook（`_temp_地球群1_2025-12-24.ipynb`）

#### b) `run_single_notebook_via_nbclient()` - 单 Notebook 执行
- 使用 `nbclient` 库执行 Notebook（不需要 Jupyter 服务器）
- 自动检测 Notebook 指定的内核（`kernelspec.name`）
- 设置 6 小时超时（覆盖大数据量情况）
- 保存执行后的 Notebook（`top5_Q2_group1_executed_2025-12-24.ipynb`）

#### c) `run_notebook_via_nbclient()` - 并行执行
- 使用 `ThreadPoolExecutor` 并行执行多个 Notebook
- 每个 Notebook 在独立线程中运行
- 汇总执行结果

**执行方式**：
```bash
# 运行昨天的分析（并行执行所有群）
python run_yesterday.py

# 运行指定日期
python run_notebook.py --date 2025-12-24

# 只运行群1
python run_notebook.py --date 2025-12-24 --group 1
```

---

### 3. save_results.py - 结果保存工具

**功能**：将 Notebook 输出的 JSON 保存到 `results/` 目录

**使用方式**：

#### 方式 A：粘贴模式（推荐）
```bash
# 1. 运行 Notebook，复制输出的 JSON
# 2. 运行保存脚本
python save_results.py --group 1 --paste

# 3. 粘贴 JSON 内容（支持多个 JSON 对象）
# 4. 输入两个空行结束

# 5. 可选：保存后自动推送
python save_results.py --group 1 --paste --push
```

#### 方式 B：从文件读取
```bash
python save_results.py --group 1 --file output.json --push
```

**保存逻辑**：
1. 解析 JSON（支持单个对象、数组、多个连续对象）
2. 按日期分组（`record.get("日期")`）
3. 为每个日期创建结果文件：
   ```json
   {
     "group": "地球群1",
     "group_id": "1",
     "date": "2025-12-24",
     "generated_at": "2025-12-24T10:30:00",
     "clusters": [...],  // 话题簇列表
     "summary": {
       "total_clusters": 5,
       "total_players": 120,
       "total_messages": 500,
       "top_cluster": "..."
     }
   }
   ```
4. 更新索引文件：
   - `results/group1/index.json` - 群1 的可用日期列表
   - `results/index.json` - 总索引

---

### 4. app.py - Streamlit 网页

**功能**：查看历史分析结果

**数据来源**：
- 优先从本地 `results/` 读取（开发时）
- 从 GitHub 原始文件 URL 读取（生产环境）
  ```
  https://raw.githubusercontent.com/norie7k/-/main/预计算方案/results/group1/2025-12-24.json
  ```

**界面功能**：
- 侧边栏：选择群和日期（日历组件）
- 主内容区：
  - 统计概览（总发言数、参与玩家数、热门话题簇数）
  - Top 5 热门话题簇（可展开查看详情）
  - 讨论点与玩家观点
  - 代表性玩家发言示例
  - 导出功能（JSON / Markdown）

**样式**：与 H5 包装保持一致（深色主题、渐变背景）

---

## 🚀 自动化流程

### 完整自动化（full_pipeline.py）

```bash
# 完整流程（下载 + 分析 + 保存 + 推送）
python full_pipeline.py

# 跳过下载（已有 txt 文件）
python full_pipeline.py --skip-download

# 跳过推送（只保存到本地）
python full_pipeline.py --skip-push

# 指定日期
python full_pipeline.py --date 2025-12-24
```

**流程步骤**：
1. **下载聊天记录** → `download_chat.py`
2. **执行分析** → `run_notebook.py`（并行执行两个 Notebook）
3. **保存结果** → `save_results.py`（需要手动粘贴 JSON）
4. **推送到 GitHub** → `git push`

**注意**：步骤 3 目前需要手动粘贴 JSON，因为 Notebook 输出在终端中。

---

## 📊 数据流

```
QQ 群聊天记录 (txt)
    ↓
[download_chat.py] 自动下载
    ↓
SOURCE_DIR/《欢迎来到地球》测试1群.txt
    ↓
[run_notebook.py] 注入配置 + 执行
    ↓
top5_Q2_group1.ipynb (执行中)
    ├─ 读取 txt → JSONL
    ├─ 模型#1: 筛选
    ├─ 模型#2: 聚类
    ├─ 模型#3: 聚合
    ├─ 模型#4: 观点分析
    └─ 输出 JSON
    ↓
终端输出 JSON（需要手动复制）
    ↓
[save_results.py] 粘贴保存
    ↓
results/group1/2025-12-24.json
results/group1/index.json
    ↓
[git push] 推送到 GitHub
    ↓
GitHub: norie7k/-/main/预计算方案/results/
    ↓
[app.py] Streamlit 网页读取并展示
```

---

## ⚙️ 关键配置

### 超时设置
- **Notebook 执行超时**：6 小时（`run_notebook.py` 中设置）
- **API 调用超时**：600 秒（Notebook 内部配置）

### 并行执行
- **线程数**：等于 Notebook 数量（目前为 2）
- **执行方式**：`ThreadPoolExecutor`（每个 Notebook 独立线程）

### 文件匹配
- **txt 文件匹配**：支持日期前缀（如 `1219《欢迎来到地球》测试1群.txt`）
- **模式匹配**：`*《欢迎来到地球》测试1群.txt`

---

## 🔍 常见问题

### Q1: Notebook 执行失败，提示 `ModuleNotFoundError`
**原因**：Notebook 使用的内核与当前 Python 环境不一致

**解决**：
- 检查 Notebook 的 `kernelspec.name`
- 确保该内核已安装所需依赖（pandas, requests 等）
- 或修改 Notebook 的 `kernelspec.name` 为 `python3`

### Q2: 如何查看 Notebook 的执行进度？
**方式**：
- 查看终端输出（实时日志）
- 查看执行后的 Notebook（`*_executed_*.ipynb`）
- 检查 API 调用日志（在 Notebook 内部）

### Q3: 如何只运行一个群？
```bash
python run_notebook.py --date 2025-12-24 --group 1
```

### Q4: 结果保存后如何推送到 GitHub？
```bash
# 方式1：使用 save_results.py 的 --push 参数
python save_results.py --group 1 --paste --push

# 方式2：手动推送
git add 预计算方案/results/
git commit -m "添加分析结果"
git push
```

---

## 📝 下一步优化建议

1. **自动化结果保存**：让 Notebook 直接调用 `save_results.py` 的保存函数，无需手动粘贴
2. **定时任务**：使用 Windows 任务计划程序或 cron，每天自动执行 `full_pipeline.py`
3. **错误处理**：增加重试机制、错误通知（邮件/微信）
4. **进度监控**：添加进度条、执行时间统计
5. **结果验证**：保存前验证 JSON 格式和必需字段


